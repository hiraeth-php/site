{% extends '@layouts/docs.html' %}

{% set title = 'Sessions' %}

{% block content %}
    {% markdown %}
        Hiraeth bootstrap uses [Aura's session package](https://github.com/auraphp/Aura.Session) for managing sesssions, this includes multiple segments and flash messaging.

        ## Obtaining the Session Manager

        You can typhing `Hiraeth\Session\ManagerInterface` to get the instance of the session manager in most contexts.

        ```php
        public function __construct(Hiraeth\Session\ManagerInterface $session_manager)
        {
            $this->sessionManager = $session_manager;
        }
        ```

        In the context of an Action, the session manager will be setter injected automatically and is available as a property of the action:

        ```php
        $session = $this->sessionManager->getSegment('auth');
        ```

        ## Session Cache

        Sessions in bootstrap use the [php-cache session handler](https://github.com/php-cache/session-handler) and are therefore stored in [caching](/docs/caching).  By and large, use of the cache directly should be limited only to a few advanced functions and sessions should operate just as normal PHP sessions.

        The session cache is registered in `config/packages/stash-session`.

        ```TOML
        [caching]

        	pools = {
        		"session": "caches/session/file"
        	}
        ```

        To change the session cache, create a new cache driver configuration in `config/caches/session` folder and simply change the value of the `session` pool to reference that collection.  Information on available cache options can be found in the [caching documentation](/docs/caching).

        ## Extending Session Lifetime at Runtime

        A common feature on websites is to allow users to optionally have the website "remember them" at login.  This works generally by extending the session lifetime on the cookie.  Since we rely on cache expiration for session garbage cleanup, the way to implement this is to increase the time on the session cache item.

        ```
        use DateTime;
        use Hiraeth\Caching\PoolManagerInterface as Cache;

        class Login extends AbstractAction
        {
            public function __construct(Cache $cache)
            {
                $this->cache   = $cache;
            }

            public function __invoke()
            {
                if ($this->get('keep', FALSE)) {
                    $pool = $this->cache->get('session');
                    $item = $pool->getItem($this->sessionManager->getId());
                    $time = DateTime::createFromFormat('U', time() + (60 * 60 * 24 * 7));

                    $item->expiresAt($time);
                    $this->cache->saveItem($item);
                }

                //
                // Do Login Things
                //
            }
        }
        ```
    {% endmarkdown %}
{% endblock %}
