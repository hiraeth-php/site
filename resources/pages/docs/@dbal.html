{% extends '@layouts/docs.html' %}

{% set title = 'Database Abstraction Library (DBAL)' %}

{% block content %}
    {% markdown %}
        Connections are the starting point for Doctrine's DBAL functionality, they enable you to execute queries (including prepared statements) as well as gain access to additional utilities for things like schema inflection, building queries, etc.  Hiraeth's DBAL integration supports mulitple connections out of the box, so the preferred way to obtain your connection is to inject the `Hiraeth\Dbal\ConnectionRegistry`:

        ```php
        use Hiraeth\Dbal\ConnectionRegistry;

        class MyService
        {
            public function __construct(ConnectionRegistry $registry)
            {
                $this->connection = $registry->getConnection('default');
            }
        }
        ```

        Once you've obtained a connection, you should be able to use it in accordance with [Doctrine's documentation](https://www.doctrine-project.org/projects/doctrine-dbal/en/2.9/reference/data-retrieval-and-manipulation.html).  In the above example, the name is optional, but if not provided will always attempt to return the connection named `default`.

        ## Multiple Connections

        Connections can be added by creating a new connection configuration in the `config/dbal` directory.  The basename of the configuration (minus the `.jin` extension) will be the name of the connection.

        The connection file itself is relatively straightforward.  Let's copy the `default.jin` called `blog.jin` and modify a few things.  We'll change our environment variable names to match our blog settings, and uncomment the password as we'll need a password to access this database.

        ```toml
        [connection]
        	driver = env(DATABASES_BLOG_TYPE)
            dbname = env(DATABASES_BLOG_NAME)
        	user = env(DATABASES_BLOG_USER)
        	password = env(DATABASES_BLOG_PASS)
        ```

        Each setting corresponds to the requisite driver settings which can be referenced in Doctrine's [connection details documentation](https://www.doctrine-project.org/projects/doctrine-dbal/en/2.9/reference/configuration.html#connection-details).  Depending on the driver you're using these settings may need to be tweaked.

        Now we can add our environment settings accordingly:

        ```toml
        [DATABASES]

        	[&.DEFAULT]

        		TYPE = pdo_pgsql
        		NAME = database
        		USER = user

        	[&.BLOG]

        		TYPE = pdo_mysql
        		NAME = blog
        		USER = bloguser
        		PASS = myS3cr3tP455werd
        ```

        Finally, we can get our blog connection thusly:

        ```php
        use Hiraeth\Dbal\ConnectionRegistry;

        class MyBlogService
        {
            public function __construct(ConnectionRegistry $registry)
            {
                $this->connection = $registry->getConnection('blog');
            }
        }
        ```

    {% endmarkdown %}
{% endblock %}
