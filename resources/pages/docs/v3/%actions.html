{% extends '@layouts/docs-3.0.html' | proxy('header', 'content') %}

{% set title = "Actions" %}

{% block header %}
	<x::title text="{{ title }}" />

	<x:docs:header>
		<h1>{{ title }}</h1>
	</x:docs:header>
{% endblock %}

{% block content %}
	{% apply markdown %}
		{: .note}
		This document assumes you've installed `hiraeth/bootstrap`{: .package} or `hiraeth/actions`{: .package} as well as either a template and middleware (`hiraeth/twig`{: .package} and `hiraeth/harmony`{: .package}) provider.

		Actions are PHP classes which perform the control logic for incoming requests.  Their primary responsibility is usually determining appropriate services and how to map incoming route parameters to those services to get or modify data.  Additionally, they may perform specific request control operations like authentication, validation, etc (even if only by calling other services).

		Actions are like controllers in other frameworks, but they only perform a single action.  Traits, abstraction and depdencency injection are all better ways to provide re-usability than loading large / complex controllers that handle lots of requests.  Continuing with our dictionary example, let's create an action that returns an actual `404` response in `local/actions/Words/Get.php`{: .file}.

		```php
		namespace Words;

		class Get extends \AbstractAction
		{
			public function __invoke($word)
			{
				$template = sprintf('@pages/words/%s.html', $word);

				if (!$this->templates->has($template)) {
					return $this->response(
						404,
						$this->template('@pages/words/404.html', [
							'word' => $word
						])
					);
				}

				return [];
			}
		}
		```

		{: .note}
		Hiraeth uses class mapping for all autoloading, so in order to find our new action you want to make sure you run `composer dump`

		## Calling Actions

		To call an action from a [page](./page), you can use Twig's `do` tag along with the `action()` function provided by `hiraeth/actions`{: .package}.  Let's update our hypothetical dictionary application's `resources/pages/words/@get.html`{: .html} file to the following:

		```twig{% verbatim %}
		{% extends '@layouts/main.html' %}

		{% do action('Words:Get') %}

		{% block body %}
			{% include '@pages/words/' ~ parameters.word ~ '.html' %}
		{% endblock %}
		{% endverbatim %}```

		{: .note}
		There's no need to pass parameters explicity to an action so long as the arguments for the action name match the parameter name.  You can, however, pass them explicitly or overload them as a second object argument to action `{word: ...}`

		## Accessing the Request {: #request}

		Although not strictly necessary, by extending the `AbstractAction`{: .class} class, our actions can easily access the [PSR-7](https://www.php-fig.org/psr/psr-7/) server request object (among other things) that represents the incoming server request:

		```php
		public function __invoke()
		{
			if ($this->request->getMethod() == 'POST') {
				...
			}
		}
		```

		For a full list of available methods, their arguments, and returned data types available on the request object, see [the PSR-7 server request interface documentation](https://www.php-fig.org/psr/psr-7/#321-psrhttpmessageserverrequestinterface).

		## Accessing the Request Data {: #request-data}

		It is 100% possible to access all request data via the server request object through standard PSR-7 interfaces.  Depending on the complexity of the incoming data, this may actually be necessary at time to distinguish between query parameters, post data, files, etc.  However, more common is the need to have this information easily combined together and/or to get default values if it hasn't been sent.

		Hiraeth's `AbstractAction`{: .class} provides two methods for easily accomplishing these tasks.

		### Checking If Data Exists {: #checking-data}

		If you need to check if a parameter has been sent (regardless of via query parameter, request body, or custom attributes), you can use the `has()`{: .method} method:

		```php
		if ($this->has('file')) {
			...
		}
		```

		### Getting Data {: #getting-data}

		To get the data by name, you can use the `get()`{: .method} method in very much the same way.

		```php
		$this->get('file')
		```

		In addition to being able to get data that has been sent, you can also provide a default in the event it hasn't.  This is common, for example, in the case of pagination, where you likely want to default to a value of `1` if a specific page has not been requested:

		```php
		$this->get('page', 1)
		```

		## Returning {: #returning}

		When actions are called they are expected to return either data (which will be added to the page's context) or a response which will interrupt the page rendering and provide some alternative.

		In the case of the former, you simply return an associative array of the data you want to make available to the template after calling the action:

		```
		return [
			'foo' => 'bar'
		];
		```

		In the case of the latter, there are several helpers which enable you to return alternative responses.

		### Redirects (With Parameters) {: #redirects }

		```php
		return $this->redirect(
			'/people',
			[
				'page' => 1
			]
		);
		```

		The default status code on a redirect will be a `303`, to change it, just wrap it:

		```php
		return $this->response(
			302,
			$this->redirect(
				'/people',
				[
					'page' => 1
				]
			)
		);
		```

		### Templates {: #templates }

		You can return an alternative template with their own response code (as seen in our opening example) like so:

		```php
		return $this->response(
			404,
			$this->template('@pages/not-found.html')
		);
		```

		## Routing

		While Hireath promotes the view-first paradigm, many people may prefer a more traditional approach where controllers (or actions in our case) are the entry point for handling a given URL.  It may also be the case, that you want to use Twig to template non-traditional formats like JSON.  For this, Hiraeth provides more traditional routing functionality that can route directly to actions or other templates.

		----

		[Add a Route](./routing){: .action}

	{% endapply %}

	{% include '@layouts/giscus.html' %}
{% endblock %}
