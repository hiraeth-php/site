{% extends '@layouts/docs-3.0.html' %}

{% set title = 'Routing' %}

{% block content %}
	{% apply markdown %}
		{: .note}
		This document assumes you've installed `hiraeth/bootstrap`{: .package} or a combination of an HTTP (`hiraeth/diactoros`{: .package}) provider and `hiraeth/fastroute`{: .package}.

		Hiraeth's bootstrap uses [FastRoute](https://github.com/nikic/FastRoute) with a custom "transformation layer" on top to provide some much needed missing features like:

		- Pattern Aliases
		- Parameter Transformers
		- Route Masks

		## Adding Routes {: #adding-routes}

		The main route map is located in `config/routes.jin`{: .config}.  Routes can be added to the `routes` map, a one-or-more tab separated values list defining the route, target, and methods for which the route applies.  The target on a route, by default, can be either a templates or actions.  Unlike pages, routes allow you finer control in that you can define distinct entry points depending on the method, load templates other than `.html`, and make use of pattern aliases, transformers, and other advanced features.  To change this:

		1. We'll rename our template to exclude the `@` on the file name portion.  The `@` signifies that a template is directly available as a page, but since we're now going to route directly to it, it can simply be `resources/pages/words/get.html`{: .html}.
		2. We'll remove our `resources/pages/words/~matchers.jin`{: .config}.  The router will now handle all URL parameterization.
		3. Finally, we'll add the route in `config/routes.jin`{: .config}:

		```toml
		[routing]
			routes = map(application.route) {
				/words/{word}	@pages/words/get.html	["GET"]
			}
		```

		{: .note}
		If you need to match all possible methods, you can use `["*"]` as the methods value.

		## Prefixes {: #prefixes}

		If you need to move all your routes under a specific path, you can use `prefix` to define the leading URL segment for all the routes in the group.  Multiple groups can have the same prefix as well, so feel free to break up your route collections in more specific groups if you like.  For example we could update our routing config as follows:

		```toml
		[routing]
			prefix = /words

			routes = map(application.route) {
				/{word}		@pages/words/get.html	["GET"]
			}
		```

		## Parameters {: #parameters}

		Parameters in routing provide much more advanced features than what's available in matcher configuration.  The basic style of a route parameter has already been shown, however, it's also possible to add custom pattern matching as well as transformers.

		In the case of words, we may want to make sure that our words are always lowercase to enforce canonical URLs.

		### Patterns {: #patterns}

		To match parameters more precisely, you can follow the parameter name in the route with a `:` and add a RegEx or a pattern alias (a simple character or string used as a shorthand):

		```toml
			routes = map(application.route) {
				/{word:lower}	@pages/words/get.html	["GET"]
			}
		```

		Given the above, the `word` will now be constrained to matching the `lower` pattern.  To add our own pattern, we can add a `[fastroute]` section to any configuration collection and set a `patterns` key equal to an object mapping the pattern alias (the key) to the regular expression (the value).  An example date pattern might look like the following:

		```toml
		[fastroute]

			patterns = {
				"lower": "[a-z]+"
			}
		```

		## Transformers {: #transformers}

		Transformers are a way to convert parameters to native PHP types (including objects) before they're passed to your actions.  Since URLs are ultimately only strings, if you're matching an integer or a date as in our example above, you may want to receive an actual integer or `DateTime` object respectively.

		Transformers are classes which must implement `Hiraeth\FastRoute\Transformer`{: .interface}.  This interface requires two methods:

		| Method       | Description
		|--------------|--------------------------------------------
		| `fromUrl()`  | Converts the paramter from the URL form (string) to the native PHP type
		| `toUrl()`    | Converts the parameter from the native PHP type (mixed) to the URL form (string)

		Let's look at how we might implement a transformer for the above date pattern to get a `DateTime` object instead of a string.

		```php
		class DateTransformer implements Hiraeth\FastRoute\Transformer
		{
			public function fromUrl($name, $value, array $context = array())
			{
				try {
					return DateTime($value);
				} catch (Exception $e) {
					return NULL;
				}
			}

			public function toUrl($name, $value, array $context = array()): string
			{
				if (!$value instanceof DateTime) {
					throw new InvalidArgumentException(sprintf(
						'Parameter %s must be a valid DateTime object',
						$name
					))
				}

				return $value->format('Y-m-d');
			}
		}
		```

	{% endapply %}
{% endblock %}
